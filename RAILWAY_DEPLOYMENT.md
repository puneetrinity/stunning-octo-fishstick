# Railway Deployment Guide for ChatSEO Platform

## Issue: Connection Refused Error

The error you're experiencing is due to the PostgreSQL database connection being refused. This typically happens when:

1. No PostgreSQL database is provisioned in Railway
2. The DATABASE_URL environment variable is not set correctly
3. The connection string format is incompatible

## Solution

### Option 1: Deploy with PostgreSQL Database (Recommended)

1. **Add PostgreSQL to your Railway project:**
   ```bash
   # In Railway dashboard:
   # 1. Click "New" → "Database" → "Add PostgreSQL"
   # 2. Railway will automatically inject DATABASE_URL
   ```

2. **The application will automatically detect and use the Railway PostgreSQL URL**

### Option 2: Deploy without Database (Demo Mode)

1. **Set environment variable in Railway:**
   ```
   SKIP_DATABASE_INIT=true
   ```

2. **This will run the application without database features**

### Option 3: Use External Database

1. **Set your own DATABASE_URL in Railway variables:**
   ```
   DATABASE_URL=postgresql://user:password@host:port/dbname
   ```

## Railway Configuration Updates Made

### 1. Railway Configuration Handler (`app/config/railway_config.py`)
- Automatically detects Railway environment
- Parses Railway's internal networking URLs
- Handles missing database gracefully
- Configures connection pooling for Railway

### 2. Updated Main Application (`main.py`)
- Added graceful database connection handling
- Continues running even if database is unavailable
- Logs clear messages about database status

### 3. Database Connection (`app/database.py`)
- Added connection testing
- Better error handling and logging
- Graceful disconnect handling

## Environment Variables for Railway

### Required (if using features):
```
# Database (auto-provided by Railway PostgreSQL)
DATABASE_URL=<auto-injected-by-railway>

# Redis (optional, for caching)
REDIS_URL=<auto-injected-by-railway>

# API Keys (required for AI features)
OPENAI_API_KEY=your-openai-key
ANTHROPIC_API_KEY=your-anthropic-key
GOOGLE_API_KEY=your-google-key

# Security
JWT_SECRET_KEY=<auto-generated-if-not-set>
```

### Optional:
```
# Skip database initialization
SKIP_DATABASE_INIT=true

# Disable Redis features
DISABLE_REDIS_FEATURES=true

# Environment
ENVIRONMENT=production
DEBUG=false
```

## Deployment Steps

1. **Push code to GitHub**

2. **In Railway:**
   - Create new project from GitHub repo
   - Add PostgreSQL database (optional)
   - Set environment variables
   - Deploy

3. **Monitor logs:**
   ```bash
   railway logs
   ```

## Testing the Deployment

### Health Check Endpoints:
- `GET /health` - Basic health check
- `GET /ready` - Readiness check with component status

### Expected Logs:
```
Starting application on port 8080
Railway configuration applied: {'database_configured': True, 'redis_configured': False, 'port': '8080'}
Starting up ChatSEO Platform...
Database connected successfully
INFO:     Started server process [1]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

## Troubleshooting

### If you still see connection errors:

1. **Check Railway PostgreSQL is provisioned:**
   - Go to Railway dashboard
   - Check if PostgreSQL service is running
   - Copy the DATABASE_URL from PostgreSQL service

2. **Verify environment variables:**
   ```bash
   railway variables
   ```

3. **Test with demo mode:**
   ```
   SKIP_DATABASE_INIT=true
   ```

4. **Check logs for specific errors:**
   ```bash
   railway logs -n 100
   ```

## Next Steps

After successful deployment:

1. Set up your API keys for AI platforms
2. Configure Redis for better performance (optional)
3. Set up custom domain in Railway
4. Enable SSL/TLS (automatic in Railway)
5. Set up monitoring and alerts

## Support

If issues persist:
- Check Railway status: https://status.railway.app/
- Review logs: `railway logs`
- Verify PostgreSQL is running in Railway dashboard
- Ensure all required environment variables are set